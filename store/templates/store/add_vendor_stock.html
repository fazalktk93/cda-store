{% extends "store/base.html" %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Add Stock for Vendor: <strong>{{ vendor.name }}</strong></h2>

    <form method="post" id="stock-form">
        {% csrf_token %}
        {{ formset.management_form }}

        <div class="row mb-3">
            <div class="col-md-6">
                <label>Voucher Number</label>
                <input type="text" name="voucher_number" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label>Voucher Date</label>
                <input type="date" name="voucher_date" class="form-control" required>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered" id="form-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Purchase Price</th>
                        <th>Quantity</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in formset %}
                    <tr class="form-row">
                        {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                        <td>{{ form.stock_item }}</td>
                        <td>{{ form.purchase_price }}</td>
                        <td>{{ form.quantity }}</td>
                        <td><button type="button" class="btn btn-danger btn-sm remove-row">Ã—</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <button type="button" class="btn btn-outline-primary" id="add-row">+ Add Another Item</button>
        <br><br>
        <button type="submit" class="btn btn-success">Save Voucher</button>
        <a href="{% url 'vendor_detail' vendor.id %}" class="btn btn-secondary">Back to Vendor</a>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const addRowBtn = document.getElementById("add-row");
    const tableBody = document.querySelector("#form-table tbody");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");

    addRowBtn.addEventListener("click", () => {
        const formIndex = parseInt(totalForms.value);
        const emptyRow = tableBody.querySelector(".form-row").cloneNode(true);

        emptyRow.querySelectorAll("input, select").forEach((input) => {
            if (input.name) {
                input.name = input.name.replace(/form-\d+/, `form-${formIndex}`);
                input.id = input.id.replace(/form-\d+/, `form-${formIndex}`);
                if (input.tagName === "SELECT") input.selectedIndex = 0;
                else input.value = "";
            }
        });

        const hiddenInputs = emptyRow.querySelectorAll("input[type=hidden]");
        hiddenInputs.forEach(h => {
            if (h.name.includes("id")) h.value = "";
        });

        totalForms.value = formIndex + 1;
        tableBody.appendChild(emptyRow);
    });

    document.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-row")) {
            const rows = document.querySelectorAll(".form-row");
            if (rows.length > 1) {
                e.target.closest(".form-row").remove();
                totalForms.value = rows.length - 1;
            }
        }
    });
</script>
{% endblock %}
