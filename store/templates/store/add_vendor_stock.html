{% extends "store/base.html" %}
{% block title %}Add Stock for {{ vendor.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Add Stock for Vendor: <strong>{{ vendor.name }}</strong></h2>

    <form method="post" id="stock-form">
        {% csrf_token %}
        {{ formset.management_form }}

        <!-- Voucher Info -->
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="voucher_number">Voucher Number</label>
                <input type="text" name="voucher_number" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label for="voucher_date">Voucher Date</label>
                <input type="date" name="voucher_date" class="form-control" required>
            </div>
        </div>

        <!-- Table -->
        <table class="table" id="form-table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Purchase Price</th>
                    <th>Quantity</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="form-body">
                {% for form in formset %}
                <tr class="form-row">
                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                    <td>{{ form.stock_item }}</td>
                    <td>{{ form.purchase_price }}</td>
                    <td>{{ form.quantity }}</td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-row">×</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <button type="button" id="add-row" class="btn btn-outline-primary">+ Add Another Item</button>
        <br><br>
        <button type="submit" class="btn btn-success">Save Voucher</button>
        <a href="{% url 'vendor_detail' vendor.id %}" class="btn btn-secondary">Back to Vendor</a>
    </form>

    <!-- Hidden template row -->
    <table class="d-none">
        <tbody>
            <tr id="empty-form-row">
                {% for hidden in formset.empty_form.hidden_fields %}{{ hidden }}{% endfor %}
                <td>{{ formset.empty_form.stock_item }}</td>
                <td>{{ formset.empty_form.purchase_price }}</td>
                <td>{{ formset.empty_form.quantity }}</td>
                <td><button type="button" class="btn btn-danger btn-sm remove-row">×</button></td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const formBody = document.getElementById("form-body");
    const addRowBtn = document.getElementById("add-row");
    const totalForms = document.getElementById("id_form-TOTAL_FORMS");
    const emptyFormRow = document.getElementById("empty-form-row");

    addRowBtn.addEventListener("click", () => {
        const newFormIdx = parseInt(totalForms.value);
        const newRow = emptyFormRow.cloneNode(true);
        newRow.classList.remove("d-none");
        newRow.removeAttribute("id");

        newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, newFormIdx);
        formBody.appendChild(newRow);
        totalForms.value = newFormIdx + 1;
    });

    formBody.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-row")) {
            const row = e.target.closest("tr");
            row.remove();
            const rows = formBody.querySelectorAll(".form-row");
            totalForms.value = rows.length;
        }
    });
});
</script>
{% endblock %}
