{% extends "store/base.html" %}
{% block title %}Issue Stock to {{ office.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Issue Stock to Office: <strong>{{ office.name }}</strong></h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form method="post" novalidate>
        {% csrf_token %}
        {{ formset.management_form }}

        <div class="row mb-4">
            <div class="col-md-4">
                <label for="{{ formset.forms.0.date_issued.id_for_label }}" class="form-label">Date Issued</label>
                {{ formset.forms.0.date_issued }}
                <div class="form-text text-danger">{{ formset.forms.0.date_issued.errors }}</div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered align-middle" id="form-table">
                <thead class="table-light text-center">
                    <tr>
                        <th>Item</th>
                        <th style="width: 140px;">Quantity</th>
                        <th>Remarks</th>
                        <th style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for form in formset %}
                    <tr class="form-row align-middle">
                        <td>
                            {{ form.stock_item|add_class:"form-select" }}
                            <div><small class="text-muted remaining-label"></small></div>
                            {{ form.stock_item.errors }}
                        </td>
                        <td>
                            {{ form.quantity_issued|add_class:"form-control text-center" }}
                            {{ form.quantity_issued.errors }}
                        </td>
                        <td>
                            {{ form.remarks|add_class:"form-control" }}
                            {{ form.remarks.errors }}
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-danger remove-row">Ã—</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <button type="button" class="btn btn-outline-primary" id="add-row">+ Add Another Item</button>
            <div>
                <button type="submit" class="btn btn-success">Issue Stock</button>
                <a href="{% url 'office_detail' office.id %}" class="btn btn-secondary">Back to Office</a>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const stockData = {{ stock_data|safe }};

    function updateRemaining(selectElement) {
        const itemId = selectElement.value;
        const label = selectElement.closest('td').querySelector('.remaining-label');
        if (itemId && stockData[itemId] !== undefined) {
            label.textContent = `Remaining: ${stockData[itemId]}`;
        } else {
            label.textContent = '';
        }
    }

    function bindSelectChange(select) {
        select.addEventListener('change', () => updateRemaining(select));
        updateRemaining(select);
    }

    document.querySelectorAll('select[name$="-stock_item"]').forEach(bindSelectChange);

    const addRowBtn = document.getElementById('add-row');
    const formTable = document.getElementById('form-table').querySelector('tbody');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');

    addRowBtn.addEventListener('click', () => {
        const formIdx = parseInt(totalForms.value);
        const firstRow = document.querySelector('.form-row');
        const newRow = firstRow.cloneNode(true);

        newRow.querySelectorAll('input, select, textarea').forEach(input => {
            if (input.name) {
                input.name = input.name.replace(/form-\d+-/, `form-${formIdx}-`);
            }
            if (input.id) {
                input.id = input.id.replace(/form-\d+-/, `form-${formIdx}-`);
            }

            if (input.tagName === 'SELECT') {
                input.selectedIndex = 0;
            } else {
                input.value = '';
            }
        });

        newRow.querySelector('.remaining-label').textContent = '';
        bindSelectChange(newRow.querySelector('select[name$="-stock_item"]'));
        formTable.appendChild(newRow);
        totalForms.value = formIdx + 1;
    });

    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-row')) {
            const row = e.target.closest('.form-row');
            const allRows = document.querySelectorAll('.form-row');
            if (allRows.length > 1) {
                row.remove();
                totalForms.value = allRows.length - 1;
            }
        }
    });
</script>
{% endblock %}
