{% extends "store/base.html" %}
{% load widget_tweaks %}
{% block title %}Issue Stock{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-8 col-lg-6">
            <h2 class="mb-4 text-center">Issue Stock</h2>

            <form method="post" novalidate>
                {% csrf_token %}
                <div class="mb-3">
                    <label for="{{ form.stock_item.id_for_label }}" class="form-label">Stock Item</label>
                    {{ form.stock_item|add_class:"form-select" }}
                    <span id="remainingQtyLabel" class="ms-2 fw-bold text-muted small"></span>
                </div>
                <div class="mb-3">
                    <label for="{{ form.office.id_for_label }}" class="form-label">Office</label>
                    {{ form.office|add_class:"form-select" }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.quantity_issued.id_for_label }}" class="form-label">Quantity Issued</label>
                    {{ form.quantity_issued|add_class:"form-control" }}
                    <span id="updatedQtyLabel" class="ms-2 fw-bold small"></span>
                </div>
                <div class="mb-3">
                    <label for="{{ form.remarks.id_for_label }}" class="form-label">Remarks</label>
                    {{ form.remarks|add_class:"form-control" }}
                </div>
                <div class="mb-3">
                    <label for="{{ form.date_issued.id_for_label }}" class="form-label">Date Issued</label>
                    {{ form.date_issued|add_class:"form-control" }}
                </div>
                <button type="submit" class="btn btn-primary w-100">Save</button>
            </form>
        </div>
    </div>
</div>

<script>
    const stockData = {{ stock_data_json|safe }};
    document.addEventListener('DOMContentLoaded', function () {
        const stockDropdown = document.getElementById('id_stock_item');
        const qtyInput = document.getElementById('id_quantity_issued');
        const remainingLabel = document.getElementById('remainingQtyLabel');
        const updatedQtyLabel = document.getElementById('updatedQtyLabel');

        function updateRemainingLabel() {
            const selectedId = stockDropdown.value;
            const currentQty = stockData[selectedId];
            remainingLabel.textContent = currentQty !== undefined ? `Remaining: ${currentQty}` : '';
            updateLiveSubtraction();
        }

        function updateLiveSubtraction() {
            const selectedId = stockDropdown.value;
            const currentQty = stockData[selectedId];
            const issueQty = parseInt(qtyInput.value);

            if (!isNaN(issueQty) && currentQty !== undefined) {
                const newQty = currentQty - issueQty;
                updatedQtyLabel.textContent = newQty >= 0
                    ? `After Issue: ${newQty}`
                    : `Not enough stock!`;
                updatedQtyLabel.style.color = newQty >= 0 ? 'green' : 'red';
            } else {
                updatedQtyLabel.textContent = '';
            }
        }

        stockDropdown.addEventListener('change', updateRemainingLabel);
        qtyInput.addEventListener('input', updateLiveSubtraction);
        updateRemainingLabel();
    });
</script>
{% endblock %}
