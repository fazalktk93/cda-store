{% extends 'store/base.html' %}
{% load static %}

{% block content %}
<h2>Issue Stock</h2>

<form method="post">
    {% csrf_token %}
    
    <div class="form-group">
        <label for="id_stock_item">Stock item:</label>
        {{ form.stock_item }}
        <span id="remainingQtyLabel" style="margin-left: 10px; font-weight: bold;"></span>
    </div>

    <div class="form-group">
        <label for="id_office">Office:</label>
        {{ form.office }}
    </div>

    <div class="form-group">
        <label for="id_quantity_issued">Quantity issued:</label>
        {{ form.quantity_issued }}
        <span id="updatedQtyLabel" style="margin-left: 10px; font-weight: bold;"></span>
    </div>

    <div class="form-group">
        <label for="id_remarks">Remarks:</label>
        {{ form.remarks }}
    </div>

    <div class="form-group">
        <label for="id_date_issued">Date issued:</label>
        {{ form.date_issued }}
    </div>

    <button type="submit" class="btn btn-primary">Save</button>
</form>

<hr>

<h4>Recently Issued Items</h4>
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>Date</th>
            <th>Item</th>
            <th>Issued To</th>
            <th>Quantity</th>
            <th>Remarks</th>
        </tr>
    </thead>
    <tbody>
        {% for issue in recent_issues %}
        <tr>
            <td>{{ issue.date_issued }}</td>
            <td>{{ issue.stock_item.name }}</td>
            <td>{{ issue.office.name }}</td>
            <td>{{ issue.quantity_issued }}</td>
            <td>{{ issue.remarks }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5">No issues yet.</td></tr>
        {% endfor %}
    </tbody>
</table>

<script>
    const stockData = {{ stock_data_json|safe }};

    document.addEventListener('DOMContentLoaded', function () {
        const stockDropdown = document.getElementById('id_stock_item');
        const qtyInput = document.getElementById('id_quantity_issued');
        const remainingLabel = document.getElementById('remainingQtyLabel');
        const updatedQtyLabel = document.getElementById('updatedQtyLabel');

        function updateRemainingLabel() {
            const selectedId = stockDropdown.value;
            const currentQty = stockData[selectedId];
            remainingLabel.textContent = currentQty !== undefined ? `Remaining: ${currentQty}` : '';
            updateLiveSubtraction(); // Also run this when dropdown changes
        }

        function updateLiveSubtraction() {
            const selectedId = stockDropdown.value;
            const currentQty = stockData[selectedId];
            const issueQty = parseInt(qtyInput.value);

            if (!isNaN(issueQty) && currentQty !== undefined) {
                const newQty = currentQty - issueQty;
                if (newQty >= 0) {
                    updatedQtyLabel.textContent = `After Issue: ${newQty}`;
                    updatedQtyLabel.style.color = 'green';
                } else {
                    updatedQtyLabel.textContent = `Not enough stock!`;
                    updatedQtyLabel.style.color = 'red';
                }
            } else {
                updatedQtyLabel.textContent = '';
            }
        }

        stockDropdown.addEventListener('change', updateRemainingLabel);
        qtyInput.addEventListener('input', updateLiveSubtraction);

        updateRemainingLabel();  // Initial run
    });
</script>
{% endblock %}
